services:
  auth-service:
    build:
      context: .
      dockerfile: backend/auth/Dockerfile
    container_name: pavitra-auth
    restart: unless-stopped
    ports:
      - "0.0.0.0:${AUTH_SERVICE_PORT}:8001"
    env_file:
      - .env
    environment:
      SERVICE_NAME: auth
    volumes:
      - ./backend:/app
      - ./logs:/app/logs
      - ./backend/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pavitra-network

  product-service:
    build:
      context: .
      dockerfile: backend/product/Dockerfile
    container_name: pavitra-product
    restart: unless-stopped
    ports:
      - "0.0.0.0:${PRODUCT_SERVICE_PORT}:8002"
    env_file:
      - .env
    environment:
      SERVICE_NAME: product
    volumes:
      - ./backend:/app
      - ./uploads:/app/uploads  # Mount uploads directory directly
      - ./logs:/app/logs
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pavitra-network

  order-service:
    build:
      context: .
      dockerfile: backend/order/Dockerfile
    container_name: pavitra-order
    restart: unless-stopped
    ports:
      - "0.0.0.0:${ORDER_SERVICE_PORT}:8003"
    env_file:
      - .env
    environment:
      SERVICE_NAME: order
    volumes:
      - ./backend:/app
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pavitra-network

  user-service:
    build:
      context: .
      dockerfile: backend/user/Dockerfile
    container_name: pavitra-user
    restart: unless-stopped
    ports:
      - "0.0.0.0:${USER_SERVICE_PORT}:8004"
    env_file:
      - .env
    environment:
      SERVICE_NAME: user
    volumes:
      - ./backend:/app
      - ./backend/uploads:/app/uploads
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pavitra-network

  payment-service:
    build:
      context: .
      dockerfile: backend/payment/Dockerfile
    container_name: pavitra-payment
    restart: unless-stopped
    ports:
      - "0.0.0.0:${PAYMENT_SERVICE_PORT}:8005"
    env_file:
      - .env
    environment:
      SERVICE_NAME: payment
    volumes:
      - ./backend:/app
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pavitra-network

  notification-service:
    build:
      context: .
      dockerfile: backend/notification/Dockerfile
    container_name: pavitra-notification
    restart: unless-stopped
    ports:
      - "0.0.0.0:${NOTIFICATION_SERVICE_PORT}:8006"
    env_file:
      - .env
    environment:
      SERVICE_NAME: notification
    volumes:
      - ./backend:/app
      - ./logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - pavitra-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "0.0.0.0:80:80"    # HTTP port for redirect
      - "0.0.0.0:443:443"  # HTTPS port
    environment:
      - NODE_ENV=production
    depends_on:
      - auth-service
      - product-service
      - order-service
      - user-service
      - payment-service
    networks:
      - pavitra-network
    restart: unless-stopped
    volumes:
      - ./ssl:/etc/nginx/ssl  # Mount SSL certificates
    healthcheck:
      test: [ "CMD", "/healthcheck.sh" ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  pavitra-network:
    external: true
    name: pavitra-micro_pavitra-network
