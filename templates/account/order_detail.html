{% extends "base.html" %}

{% block title %}Order #{{ order.order_number }} - Pavitra Enterprises{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="page-title light-background">
  <div class="container d-lg-flex justify-content-between align-items-center py-3">
    <h1 class="mb-2 mb-lg-0">Order #{{ order.order_number }}</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{{ url_for('shop.index') }}">Home</a></li>
        <li><a href="{{ url_for('shop.account') }}">Account</a></li>
        <li><a href="{{ url_for('shop.account', tab='orders') }}">My Orders</a></li>
        <li class="current">Order Details</li>
      </ol>
    </nav>
  </div>
</div>

<!-- Order Detail Section -->
<section class="order-detail section">
  <div class="container">
    <div class="row">
      <!-- Account Sidebar -->
      <div class="col-lg-3 mb-4">
        {% include "account/_account_sidebar.html" %}
      </div>

      <!-- Order Content -->
      <div class="col-lg-9">
        <!-- Order Status Card -->
        <div class="card mb-4" data-aos="fade-up">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5 class="card-title mb-3">Order Status</h5>
                <div class="d-flex align-items-center mb-3">
                  <span class="badge
                    {% if order.status == 'delivered' %}bg-success
                    {% elif order.status == 'shipped' %}bg-info
                    {% elif order.status == 'processing' %}bg-primary
                    {% elif order.status == 'confirmed' %}bg-primary
                    {% elif order.status == 'cancelled' %}bg-danger
                    {% else %}bg-warning{% endif %} fs-6 me-3">
                    {{ order.status|title }}
                  </span>
                  <span class="badge
                    {% if order.payment_status == 'paid' %}bg-success
                    {% elif order.payment_status == 'failed' %}bg-danger
                    {% else %}bg-warning{% endif %}">
                    {{ order.payment_status|title }}
                  </span>
                </div>
                <p class="mb-1 text-muted">
                  <i class="bi bi-calendar me-2"></i>
                  {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                </p>
                <p class="mb-0 text-muted">
                  <i class="bi bi-credit-card me-2"></i>
                  {{ order.payment_method|replace('_', ' ')|title }}
                </p>
              </div>
              <div class="col-md-6 text-md-end">
                <h3 class="text-success mb-2">{{ currency_symbol }}{{ "%.2f"|format(order.total_amount|float) }}</h3>
                <p class="text-muted mb-0">{{ order.order_items|length }} item(s)</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4" data-aos="fade-up" data-aos-delay="100">
          <div class="card-header bg-light">
            <h5 class="mb-0">Order Items</h5>
          </div>
          <div class="card-body p-0">
            {% if order.order_items %}
              {% for item in order.order_items %}
              <div class="order-item p-4 {% if not loop.last %}border-bottom{% endif %}">
                <div class="row align-items-center">
                  <div class="col-md-2">
                    <img src="{{ item.product_image or url_for('static', filename='img/product/placeholder.jpg') }}"
                         alt="{{ item.product_name }}"
                         class="img-fluid rounded"
                         style="width: 80px; height: 80px; object-fit: cover;">
                  </div>
                  <div class="col-md-6">
                    <h6 class="mb-1">{{ item.product_name }}</h6>
                    <p class="text-muted small mb-1">SKU: {{ item.product_sku }}</p>
                    <div class="d-flex align-items-center">
                      <span class="badge bg-light text-dark me-2">Qty: {{ item.quantity }}</span>
                      <span class="text-muted small">Ã— {{ currency_symbol }}{{ "%.2f"|format(item.unit_price|float) }}</span>
                    </div>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="h5 text-success mb-1">{{ currency_symbol }}{{ "%.2f"|format(item.total_price|float) }}</div>
                    <small class="text-muted">GST: {{ currency_symbol }}{{ "%.2f"|format(item.gst_amount|float) }}</small>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <p class="text-muted mt-3">No items found in this order.</p>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Order Summary & Addresses -->
        <div class="row">
          <!-- Order Summary -->
          <div class="col-md-6 mb-4">
            <div class="card h-100" data-aos="fade-up" data-aos-delay="200">
              <div class="card-header bg-light">
                <h5 class="mb-0">Order Summary</h5>
              </div>
              <div class="card-body">
                <div class="order-summary">
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Subtotal:</span>
                    <span class="fw-medium">{{ currency_symbol }}{{ "%.2f"|format(order.subtotal|float) }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Shipping:</span>
                    <span class="fw-medium">
                      {% if order.shipping_amount == 0 %}
                        <span class="text-success">FREE</span>
                      {% else %}
                        {{ currency_symbol }}{{ "%.2f"|format(order.shipping_amount|float) }}
                      {% endif %}
                    </span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Tax (GST):</span>
                    <span class="fw-medium">{{ currency_symbol }}{{ "%.2f"|format(order.tax_amount|float) }}</span>
                  </div>
                  {% if order.discount_amount and order.discount_amount > 0 %}
                  <div class="d-flex justify-content-between mb-2 text-success">
                    <span>Discount:</span>
                    <span class="fw-medium">-{{ currency_symbol }}{{ "%.2f"|format(order.discount_amount|float) }}</span>
                  </div>
                  {% endif %}
                  <hr>
                  <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total:</span>
                    <span class="text-success">{{ currency_symbol }}{{ "%.2f"|format(order.total_amount|float) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Shipping Address -->
          <div class="col-md-6 mb-4">
            <div class="card h-100" data-aos="fade-up" data-aos-delay="300">
              <div class="card-header bg-light">
                <h5 class="mb-0">
                  <i class="bi bi-truck me-2"></i>Shipping Address
                </h5>
              </div>
              <div class="card-body">
                {% if order.shipping_address %}
                  {% if order.shipping_address is string %}
                    <!-- Handle JSON string -->
                    <address class="mb-0">
                      {{ order.shipping_address|safe }}
                    </address>
                  {% else %}
                    <!-- Handle dictionary -->
                    <address class="mb-0">
                      <strong>{{ order.shipping_address.get('full_name', 'N/A') }}</strong><br>
                      {{ order.shipping_address.get('address_line1', '') }}<br>
                      {% if order.shipping_address.get('address_line2') %}
                      {{ order.shipping_address.get('address_line2') }}<br>
                      {% endif %}
                      {% if order.shipping_address.get('landmark') %}
                      <small class="text-muted">Landmark: {{ order.shipping_address.get('landmark') }}</small><br>
                      {% endif %}
                      {{ order.shipping_address.get('city', '') }}, {{ order.shipping_address.get('state', '') }}<br>
                      {{ order.shipping_address.get('postal_code', '') }}<br>
                      {{ order.shipping_address.get('country', 'India') }}<br>
                      <i class="bi bi-telephone me-1"></i>
                      {{ order.shipping_address.get('country_code', '+91') }} {{ order.shipping_address.get('phone', '') }}
                    </address>
                  {% endif %}
                {% else %}
                  <p class="text-muted mb-0">No shipping address provided.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Order Actions -->
        <div class="card" data-aos="fade-up" data-aos-delay="400">
          <div class="card-body text-center">
            <div class="btn-group" role="group">
              <a href="{{ url_for('shop.account', tab='orders') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>Back to Orders
              </a>

              {% if order.status in ['pending', 'confirmed'] %}
              <button type="button" class="btn btn-outline-danger ms-2" onclick="cancelOrder('{{ order.order_number }}')">
                <i class="bi bi-x-circle me-2"></i>Cancel Order
              </button>
              {% endif %}

              {% if order.status == 'delivered' %}
              <button type="button" class="btn btn-outline-success ms-2" onclick="requestReturn('{{ order.order_number }}')">
                <i class="bi bi-arrow-clockwise me-2"></i>Request Return
              </button>
              {% endif %}

              <button type="button" class="btn btn-outline-secondary ms-2" onclick="printOrder()">
                <i class="bi bi-printer me-2"></i>Print Invoice
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/order_detail.js') }}"></script>
{% endblock %}