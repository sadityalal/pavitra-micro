{% extends "base.html" %}

{% block title %}Account - Pavitra Enterprises{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="page-title light-background">
  <div class="container d-lg-flex justify-content-between align-items-center">
    <h1 class="mb-2 mb-lg-0">My Account</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{{ url_for('shop.index') }}">Home</a></li>
        <li class="current">My Account</li>
      </ol>
    </nav>
  </div>
</div><!-- End Page Title -->

<!-- Account Section -->
<section id="account" class="account section">
  <div class="container" data-aos="fade-up" data-aos-delay="100">

    <!-- Mobile Menu Toggle -->
    <div class="mobile-menu d-lg-none mb-4">
      <button class="mobile-menu-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#profileMenu">
        <i class="bi bi-grid"></i>
        <span>Menu</span>
      </button>
    </div>

    <div class="row g-4">
      <!-- Profile Menu Sidebar -->
      <div class="col-lg-3">
        {% include 'account/_account_sidebar.html' %}
      </div>

      <!-- Content Area -->
      <div class="col-lg-9">
        <div class="content-area">

          <!-- Quick Stats -->
          <div class="quick-stats mb-4" data-aos="fade-up">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="stat-card text-center p-3 rounded-3 bg-light clickable-stat" data-filter="all">
                  <div class="stat-icon text-primary mb-2">
                    <i class="bi bi-box-seam display-6"></i>
                  </div>
                  <h4 class="mb-1">{{ user_orders|length if user_orders else 0 }}</h4>
                  <p class="text-muted mb-0">Total Orders</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center p-3 rounded-3 bg-light clickable-stat" data-filter="delivered">
                  <div class="stat-icon text-success mb-2">
                    <i class="bi bi-check-circle display-6"></i>
                  </div>
                  <h4 class="mb-1">{{ delivered_orders_count }}</h4>
                  <p class="text-muted mb-0">Delivered</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center p-3 rounded-3 bg-light clickable-stat" data-filter="active">
                  <div class="stat-icon text-warning mb-2">
                    <i class="bi bi-clock display-6"></i>
                  </div>
                  <h4 class="mb-1">{{ pending_orders_count }}</h4>
                  <p class="text-muted mb-0">In Progress</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="stat-card text-center p-3 rounded-3 bg-light clickable-stat" data-filter="cancelled">
                  <div class="stat-icon text-danger mb-2">
                    <i class="bi bi-x-circle display-6"></i>
                  </div>
                  <h4 class="mb-1">{{ cancelled_orders_count }}</h4>
                  <p class="text-muted mb-0">Cancelled</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Tab Content -->
          <div class="tab-content" id="accountTabsContent">
            <!-- Orders Tab -->
            <div class="tab-pane fade {% if active_tab == 'orders' %}show active{% endif %}" id="orders-content" role="tabpanel" aria-labelledby="orders-tab">

              <!-- Order Details View (when order is selected) -->
              {% if selected_order %}
              <div class="order-detail-view" data-aos="fade-up">
                <div class="d-flex align-items-center mb-4">
                  <a href="{{ url_for('shop.account', tab='orders') }}" class="btn btn-outline-secondary btn-sm me-3">
                    <i class="bi bi-arrow-left"></i> Back to Orders
                  </a>
                  <h2 class="mb-0">Order #{{ selected_order.order_number }}</h2>
                </div>

                <!-- Order Status Card -->
                <div class="card mb-4">
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <h5 class="card-title mb-3">Order Status</h5>
                        <div class="d-flex align-items-center mb-3">
                          <!-- FIXED: Use centralized status info -->
                          {% set status_info = get_order_status_info(selected_order.status) %}
                          <span class="badge {{ status_info.badge_class }} fs-6 me-3">
                            <i class="{{ status_info.icon }} me-1"></i>
                            {{ status_info.label }}  <!-- This shows the correct status -->
                          </span>
                          <!-- FIXED: Only show payment status if it's NOT pending -->
                          {% if selected_order.payment_status != 'pending' %}
                          <span class="badge
                            {% if selected_order.payment_status == 'paid' %}bg-success
                            {% elif selected_order.payment_status == 'failed' %}bg-danger
                            {% else %}bg-warning{% endif %}">
                            Payment: {{ selected_order.payment_status|title }}
                          </span>
                          {% endif %}
                        </div>
                        <!-- FIXED: Add status description -->
                        <p class="text-muted small mb-2">
                          <i class="bi bi-info-circle me-1"></i>
                          {{ status_info.description }}
                        </p>
                        <p class="mb-1 text-muted">
                          <i class="bi bi-calendar me-2"></i>
                          {{ selected_order.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                        </p>
                        <p class="mb-0 text-muted">
                          <i class="bi bi-credit-card me-2"></i>
                          {{ selected_order.payment_method|replace('_', ' ')|title }}
                        </p>
                      </div>
                      <div class="col-md-6 text-md-end">
                        <h3 class="text-success mb-2">₹{{ "%.2f"|format(selected_order.total_amount|float) }}</h3>
                        <p class="text-muted mb-0">{{ selected_order.items|length }} item(s)</p>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Cancel Order Button in Order Details -->
                {% if selected_order.status in get_cancellable_statuses() %}
                <div class="card mb-4">
                  <div class="card-body text-center">
                    <form action="{{ url_for('shop.cancel_order', order_number=selected_order.order_number) }}" method="POST" class="d-inline">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-outline-danger cancel-order-btn"
                              onclick="return confirm('Are you sure you want to cancel order #{{ selected_order.order_number }}? This action cannot be undone.')">
                        <i class="bi bi-x-circle me-2"></i>Cancel This Order
                      </button>
                    </form>
                    <p class="text-muted mt-2 small">You can cancel orders that are pending or confirmed.</p>
                  </div>
                </div>
                {% endif %}
                <!-- Order Items -->
                <div class="card mb-4">
                  <div class="card-header bg-light">
                    <h5 class="mb-0">Order Items</h5>
                  </div>
                  <div class="card-body p-0">
                    {% if selected_order.items %}
                      {% for item in selected_order.items %}
                      <div class="order-item p-4 {% if not loop.last %}border-bottom{% endif %}">
                        <div class="row align-items-center">
                          <div class="col-md-2">
                            <img src="{{ item.product_image or url_for('static', filename='img/product/placeholder.jpg') }}"
                                 alt="{{ item.product_name }}"
                                 class="img-fluid rounded"
                                 style="width: 80px; height: 80px; object-fit: cover;">
                          </div>
                          <div class="col-md-6">
                            <h6 class="mb-1">{{ item.product_name }}</h6>
                            <p class="text-muted small mb-1">SKU: {{ item.product_sku }}</p>
                            <div class="d-flex align-items-center">
                              <span class="badge bg-light text-dark me-2">Qty: {{ item.quantity }}</span>
                              <span class="text-muted small">× ₹{{ "%.2f"|format(item.unit_price|float) }}</span>
                            </div>
                          </div>
                          <div class="col-md-4 text-end">
                            <div class="h5 text-success mb-1">₹{{ "%.2f"|format(item.total_price|float) }}</div>
                            <small class="text-muted">GST: ₹{{ "%.2f"|format(item.gst_amount|float) }}</small>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                    {% else %}
                      <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="text-muted mt-3">No items found in this order.</p>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% else %}
              <!-- Orders List View (when no specific order is selected) -->
              <div class="section-header" data-aos="fade-up">
                <h2 id="orders-title">All Orders</h2>
                <div class="header-actions">
                  <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Search orders..." id="orderSearch">
                  </div>
                </div>
              </div>

              {% if user_orders %}
              <div class="orders-grid" id="ordersGrid">
                {% for order in user_orders %}
                {% set status_info = get_order_status_info(order.status) %}
                {% set trackable_statuses = get_trackable_statuses() %}
                {% set cancellable_statuses = get_cancellable_statuses() %}

                <div class="order-card" data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}" data-order-id="{{ order.id }}" data-order-status="{{ order.status }}">
                  <div class="order-header">
                    <div class="order-id">
                      <span class="label">Order ID:</span>
                      <span class="value">{{ order.order_number }}</span>
                    </div>
                    <div class="order-date">{{ order.created_at.strftime('%b %d, %Y') }}</div>
                  </div>
                  <!-- In your account.html template, find the order status display section -->
                    <div class="order-content">
                        <div class="product-grid">
                            {% for item in order.items[:3] %}
                            <img src="{{ item.product_image or url_for('static', filename='img/product/placeholder.jpg') }}"
                                 alt="{{ item.product_name }}" loading="lazy">
                            {% endfor %}
                            {% if order.items|length > 3 %}
                            <div class="more-items">+{{ order.items|length - 3 }}</div>
                            {% endif %}
                        </div>
                        <div class="order-info">
                          <div class="info-row">
                            <span>Items</span>
                            <span>{{ order.items|length }} items</span>
                          </div>
                          <div class="info-row">
                            <span>Total</span>
                            <span class="price">₹{{ "%.2f"|format(order.total_amount) }}</span>
                          </div>
                          <div class="info-row">
                            <span>Status</span>
                            <span class="status {{ order.status|lower }}">
                              <i class="{{ status_info.icon }} me-1"></i>
                              {{ status_info.label }}  <!-- This shows the correct status -->
                            </span>
                          </div>
                        </div>
                    </div>
                  <div class="order-footer">
                    <div class="footer-actions">
                      <a href="{{ url_for('shop.account', tab='orders', order_number=order.order_number) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-eye me-1"></i>View Details
                      </a>

                      {% if order.status in trackable_statuses %}
                      <button type="button" class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#tracking{{ order.id }}">
                        <i class="bi bi-geo-alt me-1"></i>Track Order
                      </button>
                      {% endif %}

                      {% if order.status in cancellable_statuses %}
                      <form action="{{ url_for('shop.cancel_order', order_number=order.order_number) }}" method="POST" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to cancel order #{{ order.order_number }}?')">
                          <i class="bi bi-x-circle me-1"></i>Cancel Order
                        </button>
                      </form>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="empty-state" data-aos="fade-up">
                <div class="empty-icon">
                  <i class="bi bi-box-seam"></i>
                </div>
                <h3>No Orders Yet</h3>
                <p>You haven't placed any orders yet. Start shopping to see your orders here.</p>
                <a href="{{ url_for('shop.products') }}" class="btn btn-primary">Start Shopping</a>
              </div>
              {% endif %}
              {% endif %}
            </div>

            <!-- Wishlist Tab -->
            <div class="tab-pane fade {% if active_tab == 'wishlist' %}show active{% endif %}" id="wishlist-content" role="tabpanel" aria-labelledby="wishlist-tab">
              <div class="section-header" data-aos="fade-up">
                <h2>My Wishlist</h2>
                <div class="header-actions">
                  <button type="button" class="btn-add-all" id="addAllToCart">Add All to Cart</button>
                </div>
              </div>

              <div class="wishlist-grid" id="wishlistGrid">
                {% if wishlist_items %}
                  {% for item in wishlist_items %}
                  <div class="wishlist-card" data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}" data-product-id="{{ item.product.id }}">
                    <div class="wishlist-image">
                      <img src="{{ item.product.main_image_url or url_for('static', filename='img/product/placeholder.jpg') }}"
                           alt="{{ item.product.name }}" loading="lazy">
                      <button class="btn-remove remove-wishlist" type="button" aria-label="Remove from wishlist" data-item-id="{{ item.id }}">
                        <i class="bi bi-trash"></i>
                      </button>
                      {% if item.product.compare_price and item.product.compare_price > item.product.base_price %}
                      <div class="sale-badge">-{{ ((item.product.compare_price - item.product.base_price) / item.product.compare_price * 100)|round|int }}%</div>
                      {% endif %}
                      {% if not item.product.is_in_stock() %}
                      <div class="out-of-stock-badge">Out of Stock</div>
                      {% endif %}
                    </div>
                    <div class="wishlist-content">
                      <h4>{{ item.product.name }}</h4>
                      <div class="product-meta">
                        <div class="rating">
                          {% set avg_rating = item.product.get_average_rating() or 0 %}
                          {% for i in range(5) %}
                            {% if i < avg_rating %}
                              <i class="bi bi-star-fill"></i>
                            {% else %}
                              <i class="bi bi-star"></i>
                            {% endif %}
                          {% endfor %}
                          <span>({{ item.product.get_review_count() or 0 }})</span>
                        </div>
                        <div class="price">
                          <span class="current">₹{{ "%.2f"|format(item.product.base_price) }}</span>
                          {% if item.product.compare_price and item.product.compare_price > item.product.base_price %}
                          <span class="original">₹{{ "%.2f"|format(item.product.compare_price) }}</span>
                          {% endif %}
                        </div>
                      </div>
                      {% if item.product.is_in_stock() %}
                      <button type="button" class="btn-add-cart add-to-cart-wishlist" data-product-id="{{ item.product.id }}">Add to Cart</button>
                      {% else %}
                      <button type="button" class="btn-notify">Notify When Available</button>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                <div class="empty-state" data-aos="fade-up">
                  <div class="empty-icon">
                    <i class="bi bi-heart"></i>
                  </div>
                  <h3>Your Wishlist is Empty</h3>
                  <p>Save items you love to your wishlist. Review them anytime and easily move them to the bag.</p>
                  <a href="{{ url_for('shop.products') }}" class="btn btn-primary">Start Shopping</a>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Addresses Tab -->
            <div class="tab-pane fade {% if active_tab == 'addresses' %}show active{% endif %}" id="addresses-content" role="tabpanel" aria-labelledby="addresses-tab">
              <div class="section-header" data-aos="fade-up">
                <h2>My Addresses</h2>
                <div class="header-actions">
                  <button type="button" class="btn-add-new" id="showAddressForm">
                    <i class="bi bi-plus-lg"></i>
                    Add New Address
                  </button>
                </div>
              </div>

              <!-- Add Address Form (Initially Hidden) -->
              <div class="card mb-4" id="addAddressForm" style="display: none;">
                <div class="card-header">
                  <h5 class="card-title mb-0">Add New Address</h5>
                </div>
                <div class="card-body">
                  <form action="{{ url_for('shop.add_address') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    {% include 'account/_address_form.html' %}
                    <div class="mt-3">
                      <button type="submit" class="btn btn-primary">Save Address</button>
                      <button type="button" class="btn btn-secondary" id="hideAddressForm">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>

              <div class="addresses-grid">
                {% if user_addresses %}
                  {% for address in user_addresses %}
                  <div class="address-card {% if address.is_default %}default{% endif %}" data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}">
                    <div class="card-header">
                      <h4>{{ address.address_type_detail|title }}</h4>
                      {% if address.is_default %}
                      <span class="default-badge">Default</span>
                      {% endif %}
                    </div>
                    <div class="card-body">
                      <p class="address-text">
                        {{ address.full_name }}<br>
                        {{ address.address_line1 }}<br>
                        {% if address.address_line2 %}{{ address.address_line2 }}<br>{% endif %}
                        {% if address.landmark %}{{ address.landmark }}<br>{% endif %}
                        {{ address.city }}, {{ address.state }} {{ address.postal_code }}<br>
                        {{ address.country }}
                      </p>
                      <div class="contact-info">
                        <div><i class="bi bi-person"></i> {{ address.full_name }}</div>
                        <div><i class="bi bi-telephone"></i> {{ address.country_code }} {{ address.phone }}</div>
                      </div>
                    </div>
                    <div class="card-actions">
                      <form action="{{ url_for('shop.edit_address', address_id=address.id) }}" method="POST" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn-edit">
                          <i class="bi bi-pencil"></i>
                          Edit
                        </button>
                      </form>
                      {% if not address.is_default %}
                      <form action="{{ url_for('shop.delete_address', address_id=address.id) }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this address?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn-delete">
                          <i class="bi bi-trash"></i>
                          Delete
                        </button>
                      </form>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                <div class="empty-state" data-aos="fade-up">
                  <div class="empty-icon">
                    <i class="bi bi-geo-alt"></i>
                  </div>
                  <h3>No Addresses Saved</h3>
                  <p>Add your address for faster checkout and order tracking.</p>
                  <button type="button" class="btn btn-primary" id="showAddressFormEmpty">Add Address</button>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade {% if active_tab == 'settings' %}show active{% endif %}" id="settings-content" role="tabpanel" aria-labelledby="settings-tab">
              <div class="section-header" data-aos="fade-up">
                <h2>Account Settings</h2>
              </div>

              <div class="settings-content">
                <!-- Personal Information -->
                <div class="settings-section" data-aos="fade-up">
                  <h3>Personal Information</h3>
                  <form class="settings-form" id="profileForm" action="{{ url_for('shop.account') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="form_type" value="update_profile">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label for="first_name" class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="first_name" name="first_name"
                               value="{{ current_user.first_name }}" required>
                      </div>
                      <div class="col-md-6">
                        <label for="last_name" class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="last_name" name="last_name"
                               value="{{ current_user.last_name }}" required>
                      </div>
                      <div class="col-md-6">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email"
                               value="{{ current_user.email }}" required readonly>
                        <div class="form-text">Email cannot be changed</div>
                      </div>
                      <div class="col-md-6">
                        <label for="phone" class="form-label">Phone Number *</label>
                        <div class="input-group">
                          <span class="input-group-text">+91</span>
                          <input type="tel" class="form-control" id="phone" name="phone"
                                 value="{{ current_user.phone or '' }}" pattern="[0-9]{10}" maxlength="10" required>
                        </div>
                      </div>
                      <!-- Date of Birth Section - Database Enforced One-Time Setup -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="date_of_birth" class="form-label">Date of Birth</label>

                                {% if current_user.dob_set and current_user.date_of_birth %}
                                <!-- Display Only Mode - DOB Already Set (Database Enforced) -->
                                <div class="dob-display-mode">
                                    <div class="current-dob-display p-3 bg-light rounded border">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong><i class="bi bi-calendar-check text-success me-2"></i>Date of Birth:</strong>
                                                <span class="ms-2 text-primary fs-5">{{ current_user.date_of_birth.strftime('%B %d, %Y') }}</span>
                                                <span class="badge bg-success ms-2">
                                                    <i class="bi bi-person me-1"></i>
                                                    Age: {{ current_user.calculate_age() }} years
                                                </span>
                                            </div>
                                            <div class="text-muted">
                                                <i class="bi bi-shield-lock me-1"></i>
                                                <small>Permanently Set</small>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Set on {{ current_user.dob_set_at.strftime('%B %d, %Y') }} - This cannot be changed for security reasons.
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Hidden input to preserve the value and indicate DOB is set -->
                                    <input type="hidden" name="date_of_birth" value="{{ current_user.date_of_birth.strftime('%Y-%m-%d') }}">
                                    <input type="hidden" name="dob_set" value="true">
                                </div>
                                {% else %}
                                <!-- Setup Mode - DOB Not Set Yet -->
                                <div class="dob-setup-mode">
                                    <div class="setup-notice alert alert-warning mb-3">
                                        <div class="d-flex">
                                            <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                                            <div>
                                                <strong>One-time Setup Required</strong>
                                                <p class="mb-0">Your date of birth can only be set once. This is a permanent setting that cannot be changed later.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modern Date Picker Container -->
                                    <div class="date-picker-container" id="datePickerContainer">
                                        <div class="input-group">
                                            <span class="input-group-text bg-warning text-dark">
                                                <i class="bi bi-calendar3"></i>
                                            </span>
                                            <input type="text"
                                                   class="form-control date-picker-input"
                                                   id="date_of_birth"
                                                   name="date_of_birth"
                                                   value=""
                                                   placeholder="Select your date of birth (one-time setup)"
                                                   readonly
                                                   required
                                                   data-dob-set="false">

                                            <!-- Clear Button -->
                                            <button type="button" class="btn btn-outline-secondary clear-date" title="Clear date">
                                                <i class="bi bi-x-lg"></i>
                                            </button>

                                            <!-- Calendar Toggle -->
                                            <button type="button" class="btn btn-outline-warning calendar-toggle" id="calendarToggle">
                                                <i class="bi bi-chevron-down"></i>
                                            </button>
                                        </div>

                                        <!-- Modern Calendar Dropdown -->
                                        <div class="calendar-dropdown" id="calendarDropdown">
                                            <div class="calendar-header bg-warning bg-opacity-10">
                                                <button type="button" class="btn btn-sm btn-outline-secondary prev-year" title="Previous Year">
                                                    <i class="bi bi-chevron-double-left"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary prev-month" title="Previous Month">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>

                                                <div class="calendar-title">
                                                    <select class="form-select form-select-sm month-select">
                                                        <option value="0">January</option>
                                                        <option value="1">February</option>
                                                        <option value="2">March</option>
                                                        <option value="3">April</option>
                                                        <option value="4">May</option>
                                                        <option value="5">June</option>
                                                        <option value="6">July</option>
                                                        <option value="7">August</option>
                                                        <option value="8">September</option>
                                                        <option value="9">October</option>
                                                        <option value="10">November</option>
                                                        <option value="11">December</option>
                                                    </select>
                                                    <select class="form-select form-select-sm year-select">
                                                        <!-- Years will be populated by JavaScript -->
                                                    </select>
                                                </div>

                                                <button type="button" class="btn btn-sm btn-outline-secondary next-month" title="Next Month">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary next-year" title="Next Year">
                                                    <i class="bi bi-chevron-double-right"></i>
                                                </button>
                                            </div>

                                            <div class="calendar-weekdays">
                                                <div>Sun</div>
                                                <div>Mon</div>
                                                <div>Tue</div>
                                                <div>Wed</div>
                                                <div>Thu</div>
                                                <div>Fri</div>
                                                <div>Sat</div>
                                            </div>

                                            <div class="calendar-days" id="calendarDays">
                                                <!-- Calendar days will be populated by JavaScript -->
                                            </div>

                                            <div class="calendar-footer bg-warning bg-opacity-10">
                                                <button type="button" class="btn btn-sm btn-outline-secondary today-btn">Today</button>
                                                <button type="button" class="btn btn-sm btn-warning confirm-btn">
                                                    <i class="bi bi-check-lg me-1"></i>Confirm & Lock
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary cancel-btn">Cancel</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Age Preview -->
                                    <div class="age-preview mt-2" id="agePreview">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Important:</strong> This will be your permanent date of birth in our system.
                                            You will not be able to change this after confirmation.
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                      <div class="col-md-6">
                        <label for="gender" class="form-label">Gender</label>
                        <select name="gender" id="gender" class="form-select">
                            <option value="male" {% if current_user.gender == 'male' %}selected{% endif %}>Male</option>
                            <option value="female" {% if current_user.gender == 'female' %}selected{% endif %}>Female</option>
                            <option value="other" {% if current_user.gender == 'other' %}selected{% endif %}>Other</option>
                        </select>
                      </div>
                      <div class="col-12">
                        <label for="avatar_url" class="form-label">Profile Picture URL</label>
                        <input type="url" class="form-control" id="avatar_url" name="avatar_url"
                               value="{{ current_user.avatar_url or '' }}" placeholder="https://example.com/avatar.jpg">
                        <div class="form-text">Enter a URL for your profile picture</div>
                      </div>
                    </div>

                    <div class="form-buttons mt-4">
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                      <button type="reset" class="btn btn-secondary">Reset</button>
                    </div>
                  </form>
                </div>

                <!-- Security Settings -->
                <div class="settings-section" data-aos="fade-up" data-aos-delay="100">
                  <h3>Security Settings</h3>
                  <form class="settings-form" id="passwordForm" action="{{ url_for('shop.account') }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="form_type" value="change_password">
                    <div class="row g-3">
                      <div class="col-12">
                        <label for="current_password" class="form-label">Current Password *</label>
                        <input type="password" class="form-control" id="current_password" name="current_password" required>
                      </div>
                      <div class="col-md-6">
                        <label for="new_password" class="form-label">New Password *</label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required minlength="6">
                        <div class="form-text">Minimum 6 characters</div>
                      </div>
                      <div class="col-md-6">
                        <label for="confirm_password" class="form-label">Confirm Password *</label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="6">
                      </div>
                    </div>

                    <div class="form-buttons mt-4">
                      <button type="submit" class="btn btn-primary">Change Password</button>
                    </div>
                  </form>
                </div>

                <!-- Account Status -->
                <div class="settings-section" data-aos="fade-up" data-aos-delay="200">
                  <h3>Account Status</h3>
                  <div class="account-status-card">
                    <div class="status-item">
                      <span class="status-label">Email Verification:</span>
                      <span class="status-value {% if current_user.email_verified %}text-success{% else %}text-warning{% endif %}">
                        {% if current_user.email_verified %}
                          <i class="bi bi-check-circle-fill"></i> Verified
                        {% else %}
                          <i class="bi bi-exclamation-circle-fill"></i> Not Verified
                        {% endif %}
                      </span>
                    </div>
                    <div class="status-item">
                      <span class="status-label">Phone Verification:</span>
                      <span class="status-value {% if current_user.phone_verified %}text-success{% else %}text-warning{% endif %}">
                        {% if current_user.phone_verified %}
                          <i class="bi bi-check-circle-fill"></i> Verified
                        {% else %}
                          <i class="bi bi-exclamation-circle-fill"></i> Not Verified
                        {% endif %}
                      </span>
                    </div>
                    <div class="status-item">
                      <span class="status-label">Account Created:</span>
                      <span class="status-value">{{ current_user.created_at.strftime('%B %d, %Y') }}</span>
                    </div>
                    <div class="status-item">
                      <span class="status-label">Last Login:</span>
                      <span class="status-value">
                        {% if current_user.last_login %}
                          {{ current_user.last_login.strftime('%B %d, %Y at %I:%M %p') }}
                        {% else %}
                          Never
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- NEW: Account Management Section -->
                <div class="settings-section" data-aos="fade-up" data-aos-delay="300">
                  <h3 class="text-danger">Account Management</h3>

                  <!-- Account Status Card -->
                  <div class="account-status-card border-danger">
                    <div class="status-item">
                      <span class="status-label">Account Status:</span>
                      <span class="status-value {% if current_user.is_active %}text-success{% else %}text-danger{% endif %}">
                        {% if current_user.is_active %}
                          <i class="bi bi-check-circle-fill"></i> Active
                        {% else %}
                          <i class="bi bi-x-circle-fill"></i> Deactivated
                        {% endif %}
                      </span>
                    </div>

                    {% set account_status = current_user.get_account_status() %}
                    {% if account_status.deletion_scheduled %}
                    <div class="status-item">
                      <span class="status-label">Deletion Scheduled:</span>
                      <span class="status-value text-warning">
                        <i class="bi bi-clock-fill me-1"></i>
                        {{ account_status.days_until_deletion }} days remaining
                      </span>
                    </div>
                    {% endif %}
                  </div>

                  <!-- Action Buttons -->
                  <div class="account-actions mt-4">
                    {% if current_user.is_active %}
                      <!-- Deactivate Account -->
                      <div class="card border-warning mb-3">
                        <div class="card-header bg-warning bg-opacity-10">
                          <h5 class="card-title mb-0"><i class="bi bi-pause-circle me-2"></i>Temporary Deactivation</h5>
                        </div>
                        <div class="card-body">
                          <p class="card-text">Temporarily deactivate your account. You can reactivate it anytime by logging in.</p>
                          <ul class="small text-muted">
                            <li>Your data will be preserved</li>
                            <li>You can reactivate anytime</li>
                            <li>No one will see your profile</li>
                          </ul>
                          <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#deactivateModal">
                            Deactivate Account
                          </button>
                        </div>
                      </div>

                      <!-- Delete Account -->
                      <div class="card border-danger">
                        <div class="card-header bg-danger bg-opacity-10">
                          <h5 class="card-title mb-0"><i class="bi bi-trash me-2"></i>Permanent Deletion</h5>
                        </div>
                        <div class="card-body">
                          <p class="card-text">Permanently delete your account and all associated data.</p>
                          <ul class="small text-muted">
                            <li>30-day grace period to cancel</li>
                            <li>All your data will be deleted</li>
                            <li>This action cannot be undone</li>
                          </ul>

                          {% if current_user.can_delete_account() %}
                          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            Delete Account
                          </button>
                          {% else %}
                          <button type="button" class="btn btn-danger" disabled title="Cannot delete account with pending orders">
                            Delete Account (Pending Orders)
                          </button>
                          <small class="text-muted d-block mt-1">Complete or cancel all pending orders before deleting your account.</small>
                          {% endif %}
                        </div>
                      </div>
                    {% else %}
                      <!-- Reactivate Account Info -->
                      <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle me-2"></i>Account Deactivated</h5>
                        <p class="mb-0">Your account is currently deactivated. You can reactivate it by logging in again.</p>
                      </div>
                    {% endif %}

                    {% if account_status.deletion_scheduled %}
                      <!-- Cancel Deletion Request -->
                      <div class="card border-success">
                        <div class="card-header bg-success bg-opacity-10">
                          <h5 class="card-title mb-0"><i class="bi bi-arrow-counterclockwise me-2"></i>Cancel Deletion Request</h5>
                        </div>
                        <div class="card-body">
                          <p class="card-text">Your account is scheduled for deletion in {{ account_status.days_until_deletion }} days.</p>
                          <form action="{{ url_for('shop.cancel_account_deletion') }}" method="POST" class="d-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-success" onclick="return confirm('Cancel account deletion request?')">
                              Cancel Deletion
                            </button>
                          </form>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
                <!-- END: Account Management Section -->

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section><!-- /Account Section -->

<!-- Deactivation Modal -->
<div class="modal fade" id="deactivateModal" tabindex="-1" aria-labelledby="deactivateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="deactivateModalLabel"><i class="bi bi-exclamation-triangle me-2"></i>Deactivate Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to deactivate your account?</p>
        <ul>
          <li>Your profile will be hidden</li>
          <li>You can reactivate anytime by logging in</li>
          <li>Your data will be preserved</li>
        </ul>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="confirmDeactivate">
          <label class="form-check-label" for="confirmDeactivate">
            I understand that I can reactivate my account anytime
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{{ url_for('shop.deactivate_account') }}" method="POST" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-warning" id="deactivateSubmit" disabled>
            Deactivate Account
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Deletion Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel"><i class="bi bi-exclamation-triangle me-2"></i>Delete Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <h6 class="alert-heading">This action cannot be undone!</h6>
          <p class="mb-0">All your data will be permanently deleted after 30 days.</p>
        </div>
        <p>Before proceeding, please understand:</p>
        <ul>
          <li>Your account will be scheduled for deletion in 30 days</li>
          <li>You can cancel this request anytime during the 30-day period</li>
          <li>After 30 days, all your data will be permanently deleted</li>
          <li>This includes orders, addresses, wishlist, and profile information</li>
        </ul>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="confirmDelete1">
          <label class="form-check-label" for="confirmDelete1">
            I understand that my account will be permanently deleted after 30 days
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="confirmDelete2">
          <label class="form-check-label" for="confirmDelete2">
            I understand this action cannot be undone after 30 days
          </label>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="confirmDelete3">
          <label class="form-check-label" for="confirmDelete3">
            I have downloaded any important data I wish to keep
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{{ url_for('shop.request_account_deletion') }}" method="POST" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger" id="deleteSubmit" disabled>
            Schedule Account Deletion
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/account.js') }}"></script>
{% endblock %}