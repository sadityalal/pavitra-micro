{% extends "base.html" %}

{% block title %}Products - Pavitra Enterprises{% endblock %}
{% block description %}Browse our complete collection of quality products. Find electronics, fashion, home goods and more at great prices with fast shipping across India.{% endblock %}
{% block keywords %}products, shopping, electronics, fashion, home goods, pavitra enterprises, buy online{% endblock %}

{% block content %}
<!-- Page Title -->
<div class="page-title light-background">
  <div class="container d-lg-flex justify-content-between align-items-center py-3">
    <h1 data-aos="fade-up">Our Products</h1>
    <nav class="breadcrumbs">
      <ol>
        <li><a href="{{ url_for('shop.index') }}">Home</a></li>
        <li class="current">Products</li>
      </ol>
    </nav>
  </div>
</div><!-- End Page Title -->

<!-- Products Section -->
<section class="products-section section pt-4">
  <div class="container">
    <div class="row">

      <!-- Sidebar Filters -->
      <div class="col-lg-3 col-md-4">
        <div class="products-sidebar position-sticky" style="top: 100px;" data-aos="fade-right" data-aos-delay="100">

          <!-- Categories Filter -->
          <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-light">
              <h5 class="mb-0 text-dark"><i class="bi bi-grid-3x3-gap me-2"></i>Categories</h5>
            </div>
            <div class="card-body p-0 bg-light">
              <div class="list-group list-group-flush">
                <a href="{{ url_for('shop.products') }}"
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if not category_slug %}active{% endif %} border-0">
                  All Categories
                  <span class="badge {% if not category_slug %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">{{ products|length if products else 0 }}</span>
                </a>
                {% for category in categories %}
                <a href="{{ url_for('shop.category', slug=category.slug) }}"
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if category_slug == category.slug %}active{% endif %} border-0">
                  {{ category.name }}
                  <span class="badge {% if category_slug == category.slug %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill">{{ category.products|length if category.products else 0 }}</span>
                </a>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Price Filter -->
          <div class="card shadow-sm border-0 mb-3" data-aos="fade-right" data-aos-delay="200">
            <div class="card-header bg-light">
              <h5 class="mb-0 text-dark"><i class="bi bi-currency-rupee me-2"></i>Price Range</h5>
            </div>
            <div class="card-body bg-light">
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="form-label small text-dark">Min</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white text-dark border-secondary">{{ currency_symbol }}</span>
                    <input type="number" class="form-control border-secondary" id="minPrice" placeholder="0" value="0" min="0">
                  </div>
                </div>
                <div class="col-6">
                  <label class="form-label small text-dark">Max</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text bg-white text-dark border-secondary">{{ currency_symbol }}</span>
                    <input type="number" class="form-control border-secondary" id="maxPrice" placeholder="100000" value="100000" min="0">
                  </div>
                </div>
              </div>
              <button class="btn btn-dark btn-sm w-100 border-0" onclick="applyPriceFilter()">
                Apply Filter
              </button>
            </div>
          </div>

          <!-- Brands Filter -->
          <div class="card shadow-sm border-0 mb-3" data-aos="fade-right" data-aos-delay="300">
            <div class="card-header bg-light">
              <h5 class="mb-0 text-dark"><i class="bi bi-tags me-2"></i>Brands</h5>
            </div>
            <div class="card-body bg-light">
              <div class="brands-list" style="max-height: 200px; overflow-y: auto;">
                {% if brands %}
                  {% for brand in brands %}
                  <div class="form-check mb-2">
                    <input class="form-check-input border-dark brand-filter" type="checkbox" value="{{ brand.id }}" id="brand{{ brand.id }}">
                    <label class="form-check-label small text-dark" for="brand{{ brand.id }}">
                      {{ brand.name }}
                      {% if brand.is_indian_brand %}
                      <span class="badge bg-success ms-1 border-0">IN</span>
                      {% endif %}
                    </label>
                  </div>
                  {% endfor %}
                {% else %}
                  <p class="small text-muted">No brands available</p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Stock Status Filter -->
          <div class="card shadow-sm border-0 mb-3" data-aos="fade-right" data-aos-delay="350">
            <div class="card-header bg-light">
              <h5 class="mb-0 text-dark"><i class="bi bi-box me-2"></i>Stock Status</h5>
            </div>
            <div class="card-body bg-light">
              <div class="form-check mb-2">
                <input class="form-check-input border-primary stock-filter" type="checkbox" value="in_stock" id="inStock">
                <label class="form-check-label small text-dark" for="inStock">
                  In Stock
                </label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input border-primary stock-filter" type="checkbox" value="low_stock" id="lowStock">
                <label class="form-check-label small text-dark" for="lowStock">
                  Low Stock
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input border-primary stock-filter" type="checkbox" value="out_of_stock" id="outOfStock">
                <label class="form-check-label small text-dark" for="outOfStock">
                  Out of Stock
                </label>
              </div>
            </div>
          </div>

          <!-- Clear Filters -->
          <button class="btn btn-outline-dark w-100 border-dark" onclick="clearAllFilters()" data-aos="fade-right" data-aos-delay="400">
            <i class="bi bi-arrow-clockwise me-2"></i>Clear All Filters
          </button>

        </div>
      </div>

      <!-- Products Grid -->
      <div class="col-lg-9 col-md-8">

        <!-- Products Header -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3" data-aos="fade-up">
          <div class="mb-2 mb-md-0">
            <p class="text-muted mb-0">
              Showing <strong class="text-dark" id="showingCount">{{ products|length if products else 0 }}</strong> of
              <strong class="text-dark">{{ products|length if products else 0 }}</strong> products
            </p>
          </div>
          <div class="d-flex gap-2">
            <!-- Sort Options -->
            <div class="dropdown">
              <button class="btn btn-outline-dark dropdown-toggle border-dark" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-sort-down me-2"></i>Sort By
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item sort-option" href="#" data-sort="name_asc">Name: A to Z</a></li>
                <li><a class="dropdown-item sort-option" href="#" data-sort="name_desc">Name: Z to A</a></li>
                <li><a class="dropdown-item sort-option" href="#" data-sort="price_asc">Price: Low to High</a></li>
                <li><a class="dropdown-item sort-option" href="#" data-sort="price_desc">Price: High to Low</a></li>
                <li><a class="dropdown-item sort-option" href="#" data-sort="newest">Newest First</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="products-container">
          <div class="row g-3" id="productsGrid">
            {% if products %}
              {% for product in products %}
              <div class="col-xl-4 col-lg-6 col-md-6 product-item"
                   data-price="{{ product.base_price|float }}"
                   data-brand="{{ product.brand_id if product.brand_id else '' }}"
                   data-stock="{{ product.stock_status }}"
                   data-category="{{ product.category_id }}"
                   data-name="{{ product.name.lower() }}"
                   data-created="{{ product.created_at.timestamp() if product.created_at else 0 }}">

                <div class="card h-100 shadow-sm border-0 product-card"
                     style="cursor: pointer;"
                     onclick="window.location.href='{{ url_for('shop.product_detail', slug=product.slug) }}'"
                     data-aos="zoom-in"
                     data-aos-delay="{{ loop.index0 * 50 }}">

                  <div class="position-relative overflow-hidden">
                    {% if product.main_image_url %}
                    <img src="{{ product.main_image_url }}" alt="{{ product.name }}" class="card-img-top" style="height: 220px; object-fit: cover;" loading="lazy">
                    {% else %}
                    <img src="{{ url_for('static', filename='img/product/placeholder.jpg') }}" alt="{{ product.name }}" class="card-img-top" style="height: 220px; object-fit: cover;" loading="lazy">
                    {% endif %}

                    <!-- Product Badges -->
                    <div class="position-absolute top-0 start-0 p-2">
                      {% if product.compare_price and product.compare_price > product.base_price %}
                      <span class="badge bg-danger border-0">-{{ ((1 - product.base_price / product.compare_price) * 100)|round|int }}%</span>
                      {% endif %}
                      {% if product.is_featured %}
                      <span class="badge bg-dark text-white border-0">Featured</span>
                      {% endif %}
                      {% if product.stock_status == 'low_stock' %}
                      <span class="badge bg-warning text-dark border-0">Low Stock</span>
                      {% endif %}
                    </div>

                    <!-- Product Actions -->
                    <div class="position-absolute top-0 end-0 p-2" onclick="event.stopPropagation()">
                      <div class="btn-group-vertical">
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-light btn-sm rounded-circle mb-1 border-0 wishlist-btn"
                                onclick="addToWishlist({{ product.id }}, this)"
                                title="Add to Wishlist">
                          <i class="bi bi-heart"></i>
                        </button>
                        {% else %}
                        <button class="btn btn-light btn-sm rounded-circle mb-1 border-0"
                                onclick="showLoginAlert(event)"
                                title="Add to Wishlist (Login Required)">
                          <i class="bi bi-heart"></i>
                        </button>
                        {% endif %}
                        <a href="{{ url_for('shop.product_detail', slug=product.slug) }}"
                           class="btn btn-light btn-sm rounded-circle border-0"
                           title="View Details">
                          <i class="bi bi-eye"></i>
                        </a>
                      </div>
                    </div>
                  </div>

                  <div class="card-body d-flex flex-column p-3">
                    <!-- Category & Brand -->
                    <div class="small text-muted mb-1">
                      {{ product.category.name if product.category else 'Uncategorized' }}
                      {% if product.brand %}
                      • {{ product.brand.name }}
                      {% if product.brand.is_indian_brand %}
                      <span class="badge bg-success ms-1 border-0">IN</span>
                      {% endif %}
                      {% endif %}
                    </div>

                    <!-- Product Name -->
                    <h5 class="card-title flex-grow-1 mb-1">
                      <a href="{{ url_for('shop.product_detail', slug=product.slug) }}"
                         class="text-decoration-none text-dark"
                         onclick="event.stopPropagation()">
                        {{ product.name }}
                      </a>
                    </h5>

                    <!-- Rating -->
                    <div class="d-flex align-items-center mb-2">
                      <div class="text-warning me-2">
                        {% set avg_rating = product.get_average_rating() or 0 %}
                        {% for i in range(5) %}
                          {% if i < avg_rating|int %}
                            <i class="bi bi-star-fill"></i>
                          {% else %}
                            <i class="bi bi-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <small class="text-muted">({{ product.get_review_count() or 0 }})</small>
                    </div>

                    <!-- Price -->
                    <div class="d-flex align-items-center mb-2">
                      {% if product.compare_price and product.compare_price > product.base_price %}
                      <span class="text-muted text-decoration-line-through me-2">{{ currency_symbol }}{{ "%.2f"|format(product.compare_price|float) }}</span>
                      {% endif %}
                      <span class="h5 text-dark mb-0 fw-bold">{{ currency_symbol }}{{ "%.2f"|format(product.base_price|float) }}</span>
                    </div>

                    <!-- Add to Cart Button -->
                    <div class="d-grid mt-auto">
                      {% if product.stock_quantity and product.stock_quantity > 0 %}
                      <button class="btn btn-dark border-0 add-to-cart-btn"
                              onclick="event.stopPropagation(); addToCart({{ product.id }}, this)">
                        <i class="bi bi-cart-plus me-2"></i>Add to Cart
                      </button>
                      {% else %}
                      <button class="btn btn-secondary border-0" disabled>
                        <i class="bi bi-x-circle me-2"></i>Out of Stock
                      </button>
                      {% endif %}
                    </div>

                    <!-- Stock & GST Info -->
                    <div class="small text-muted mt-2">
                      {% if product.stock_quantity and product.stock_quantity <= product.low_stock_threshold %}
                      <div class="text-warning mb-1">
                        <i class="bi bi-exclamation-triangle"></i> Only {{ product.stock_quantity }} left!
                      </div>
                      {% endif %}
                      <div>
                        <i class="bi bi-receipt"></i> GST: {{ product.gst_rate }}% inclusive
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <!-- Empty State -->
              <div class="col-12">
                <div class="text-center py-4" data-aos="fade-up">
                  <div class="mb-3">
                    <i class="bi bi-search display-1 text-muted"></i>
                  </div>
                  <h3 class="text-muted">No Products Found</h3>
                  <p class="text-muted mb-3">We couldn't find any products matching your criteria.</p>
                  <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-dark" onclick="clearAllFilters()">Clear All Filters</button>
                    <a href="{{ url_for('shop.products') }}" class="btn btn-outline-dark">View All Products</a>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Load More Button (for future pagination) -->
        {% if products and products|length >= 12 %}
        <div class="text-center mt-4" data-aos="fade-up">
          <button class="btn btn-outline-dark" id="loadMoreBtn" style="display: none;">
            <i class="bi bi-arrow-down me-2"></i>Load More Products
          </button>
        </div>
        {% endif %}

      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/shop_product.js') }}"></script>
{% endblock %}