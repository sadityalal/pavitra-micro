{% extends "admin/base.html" %}

{% block title %}User Details - {{ user.get_full_name() }} - Pavitra Enterprises{% endblock %}

{% block page_title %}User Details: {{ user.get_full_name() }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.user_management') }}">Users</a></li>
<li class="breadcrumb-item active">{{ user.get_full_name() }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="d-flex align-items-center">
        {% if user.avatar_url %}
        <img src="{{ user.avatar_url }}" alt="{{ user.first_name }}" class="rounded-circle me-3" width="80" height="80">
        {% else %}
        <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 80px;">
          <i class="bi bi-person text-white fs-3"></i>
        </div>
        {% endif %}
        <div>
          <h4 class="mb-1">{{ user.get_full_name() }}</h4>
          <p class="text-muted mb-1">{{ user.email }}</p>
          <div>
            {% if user.is_admin %}
            <span class="badge bg-info me-1">Admin</span>
            {% endif %}
            {% if user.is_active %}
            <span class="badge bg-success me-1">Active</span>
            {% else %}
            <span class="badge bg-secondary me-1">Inactive</span>
            {% endif %}
            {% if user.email_verified %}
            <span class="badge bg-success me-1">Email Verified</span>
            {% else %}
            <span class="badge bg-warning me-1">Email Not Verified</span>
            {% endif %}
            {% if user.phone_verified %}
            <span class="badge bg-success me-1">Phone Verified</span>
            {% else %}
            <span class="badge bg-warning me-1">Phone Not Verified</span>
            {% endif %}
            {% if user.deletion_scheduled_at %}
            <span class="badge bg-danger me-1">Scheduled for Deletion</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <a href="{{ url_for('admin.user_management') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Users
      </a>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="stats-card card">
        <div class="card-body">
          <div class="stats-icon text-primary">
            <i class="bi bi-cart"></i>
          </div>
          <div class="stats-content">
            <h3>{{ orders_count }}</h3>
            <p>Total Orders</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="stats-card card">
        <div class="card-body">
          <div class="stats-icon text-success">
            <i class="bi bi-geo-alt"></i>
          </div>
          <div class="stats-content">
            <h3>{{ addresses_count }}</h3>
            <p>Addresses</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="stats-card card">
        <div class="card-body">
          <div class="stats-icon text-info">
            <i class="bi bi-star"></i>
          </div>
          <div class="stats-content">
            <h3>{{ reviews_count }}</h3>
            <p>Reviews</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
      <div class="stats-card card">
        <div class="card-body">
          <div class="stats-icon text-warning">
            <i class="bi bi-heart"></i>
          </div>
          <div class="stats-content">
            <h3>{{ wishlist_count }}</h3>
            <p>Wishlist Items</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column - User Information -->
    <div class="col-md-6">
      <!-- Basic Information Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-info-circle me-2"></i>Basic Information
          </h5>
        </div>
        <div class="card-body">
          <table class="table table-sm table-borderless">
            <tr>
              <td width="40%"><strong>User ID:</strong></td>
              <td>{{ user.id }}</td>
            </tr>
            <tr>
              <td><strong>Email:</strong></td>
              <td>{{ user.email }}</td>
            </tr>
            <tr>
              <td><strong>Phone:</strong></td>
              <td>{{ user.get_full_phone() or 'Not provided' }}</td>
            </tr>
            <tr>
              <td><strong>Account Created:</strong></td>
              <td>{{ user.created_at.strftime('%d %b %Y at %H:%M') if user.created_at else 'N/A' }}</td>
            </tr>
            <tr>
              <td><strong>Last Login:</strong></td>
              <td>{{ user.last_login.strftime('%d %b %Y at %H:%M') if user.last_login else 'Never' }}</td>
            </tr>
            {% if user.date_of_birth %}
            <tr>
              <td><strong>Date of Birth:</strong></td>
              <td>{{ user.date_of_birth.strftime('%d %b %Y') }}</td>
            </tr>
            {% endif %}
            {% if user.deletion_scheduled_at %}
            <tr>
              <td><strong>Deletion Scheduled:</strong></td>
              <td class="text-danger">{{ user.deletion_scheduled_at.strftime('%d %b %Y at %H:%M') }}</td>
            </tr>
            {% endif %}
          </table>
        </div>
      </div>

      <!-- Account Actions Card -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-gear me-2"></i>Account Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            {% if not user.is_admin and user.id != current_user.id %}
              {% if user.is_active and not user.deletion_scheduled_at %}
              <button type="button" class="btn btn-outline-warning"
                      data-admin-user-action="deactivate"
                      data-user-id="{{ user.id }}"
                      data-user-email="{{ user.email }}">
                <i class="bi bi-person-x me-1"></i>Deactivate User
              </button>
              {% elif not user.is_active %}
              <button type="button" class="btn btn-outline-success"
                      data-admin-user-action="reactivate"
                      data-user-id="{{ user.id }}"
                      data-user-email="{{ user.email }}">
                <i class="bi bi-person-check me-1"></i>Reactivate User
              </button>
              {% endif %}

              {% if user.deletion_scheduled_at %}
              <button type="button" class="btn btn-outline-info"
                      data-admin-user-action="cancel-deletion"
                      data-user-id="{{ user.id }}"
                      data-user-email="{{ user.email }}">
                <i class="bi bi-x-circle me-1"></i>Cancel Scheduled Deletion
              </button>
              {% endif %}

              <form action="{{ url_for('admin.delete_user_now', user_id=user.id) }}" method="POST" class="d-grid">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-danger"
                        onclick="return confirm('Are you sure you want to permanently delete {{ user.email }}? This action cannot be undone!')">
                  <i class="bi bi-trash me-1"></i>Delete User Immediately
                </button>
              </form>
            {% else %}
              <p class="text-muted text-center mb-0">
                <i class="bi bi-info-circle me-1"></i>
                Limited actions available for admin users or your own account.
              </p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Addresses Card -->
      {% if user_addresses %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-geo-alt me-2"></i>Saved Addresses ({{ addresses_count }})
          </h5>
        </div>
        <div class="card-body">
          {% for address in user_addresses %}
          <div class="border rounded p-3 mb-3 {% if address.is_default %}border-primary{% endif %}">
            {% if address.is_default %}
            <span class="badge bg-primary mb-2">Default</span>
            {% endif %}
            <h6 class="mb-2">{{ address.full_name }}</h6>
            <p class="mb-1 small">{{ address.address_line1 }}</p>
            {% if address.address_line2 %}
            <p class="mb-1 small">{{ address.address_line2 }}</p>
            {% endif %}
            <p class="mb-1 small">
              {{ address.city }}, {{ address.state }} - {{ address.postal_code }}
            </p>
            <p class="mb-1 small">{{ address.country }}</p>
            <p class="mb-0 small text-muted">
              <i class="bi bi-telephone"></i> {{ address.phone }}
            </p>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Right Column - Activity -->
    <div class="col-md-6">
      <!-- Recent Orders Card -->
      {% if recent_orders %}
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="bi bi-cart me-2"></i>Recent Orders ({{ orders_count }} total)
          </h5>
          <a href="{{ url_for('admin.orders', q=user.email) }}" class="btn btn-sm btn-outline-primary">
            View All Orders
          </a>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for order in recent_orders %}
                <tr>
                  <td>
                    <a href="{{ url_for('admin.order_detail', order_id=order.id) }}" class="text-decoration-none">
                      {{ order.order_number }}
                    </a>
                  </td>
                  <td>{{ order.created_at.strftime('%d %b %Y') }}</td>
                  <td>â‚¹{{ "%.2f"|format(order.total_amount) }}</td>
                  <td>
                    <span class="badge bg-{{ 'success' if order.status == 'delivered' else 'warning' if order.status == 'pending' else 'info' if order.status in ['confirmed', 'processing', 'shipped'] else 'danger' if order.status == 'cancelled' else 'secondary' }}">
                      {{ order.status|title }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card mb-4">
        <div class="card-body text-center py-5">
          <i class="bi bi-cart-x display-4 text-muted"></i>
          <h5 class="text-muted mt-3">No Orders Yet</h5>
          <p class="text-muted">This user hasn't placed any orders.</p>
        </div>
      </div>
      {% endif %}

      <!-- Recent Reviews Card -->
      {% if recent_reviews %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-star me-2"></i>Recent Reviews ({{ reviews_count }} total)
          </h5>
        </div>
        <div class="card-body">
          {% for review in recent_reviews %}
          <div class="border-bottom pb-3 mb-3 {% if loop.last %}border-0 mb-0 pb-0{% endif %}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <strong>
                {% if review.product %}
                <a href="{{ url_for('shop.product_detail', product_id=review.product.id, slug=review.product.slug) }}" class="text-decoration-none">
                  {{ review.product.name }}
                </a>
                {% else %}
                Product
                {% endif %}
              </strong>
              <div>
                {% for i in range(5) %}
                <i class="bi bi-star{% if i < review.rating %}-fill text-warning{% endif %}"></i>
                {% endfor %}
              </div>
            </div>
            <p class="mb-2">{{ review.comment|truncate(100) }}</p>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">{{ review.created_at.strftime('%d %b %Y') }}</small>
              <span class="badge bg-{{ 'success' if review.status == 'approved' else 'warning' if review.status == 'pending' else 'secondary' }}">
                {{ review.status|title }}
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Account Status Card -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-shield-check me-2"></i>Account Status
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="border-end">
                <h4 class="text-{{ 'success' if user.is_active else 'danger' }}">{{ 'Active' if user.is_active else 'Inactive' }}</h4>
                <small class="text-muted">Account Status</small>
              </div>
            </div>
            <div class="col-6">
              <h4 class="text-{{ 'success' if user.email_verified else 'warning' }}">{{ 'Verified' if user.email_verified else 'Pending' }}</h4>
              <small class="text-muted">Email Verification</small>
            </div>
          </div>
          {% if user.deletion_scheduled_at %}
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Account scheduled for deletion</strong><br>
            This account will be permanently deleted on {{ user.deletion_scheduled_at.strftime('%d %b %Y at %H:%M') }}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- No inline JavaScript needed - handled by admin_users.js -->
{% endblock %}