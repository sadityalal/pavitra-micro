{% extends "admin/base.html" %}

{% block title %}Order #{{ order.order_number }} - Pavitra Enterprises{% endblock %}

{% block page_title %}Order Details{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin.orders') }}">Orders</a></li>
<li class="breadcrumb-item active">#{{ order.order_number }}</li>
{% endblock %}

{% block content %}
<!-- Order Details Section -->
<section class="section">
  <div class="container-fluid">
    <div class="row">
      <!-- Order Information -->
      <div class="col-lg-8">
        <!-- Order Header -->
        <div class="card mb-4" data-aos="fade-up">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
              <i class="bi bi-receipt me-2"></i>Order #{{ order.order_number }}
            </h5>
            <div class="d-flex gap-2 align-items-center">
              <span class="badge
                {% if order.status == 'pending' %}bg-warning
                {% elif order.status == 'confirmed' %}bg-info
                {% elif order.status == 'processing' %}bg-primary
                {% elif order.status == 'shipped' %}bg-secondary
                {% elif order.status == 'delivered' %}bg-success
                {% else %}bg-danger{% endif %} fs-6">
                {{ order.status|title }}
              </span>
              <span class="badge
                {% if order.payment_status == 'paid' %}bg-success
                {% elif order.payment_status == 'pending' %}bg-warning
                {% else %}bg-danger{% endif %} fs-6">
                {{ order.payment_status|title }}
              </span>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <strong class="text-muted">Order Date:</strong>
                  <span class="ms-2">{{ order.created_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                <div class="mb-3">
                  <strong class="text-muted">Order Total:</strong>
                  <span class="ms-2 fw-bold text-success">₹{{ "%.2f"|format(order.total_amount) }}</span>
                </div>
                <div class="mb-3">
                  <strong class="text-muted">Payment Method:</strong>
                  <span class="ms-2 text-capitalize">{{ order.payment_method|replace('_', ' ') }}</span>
                </div>
              </div>
              <div class="col-md-6">
                {% if order.paid_at %}
                <div class="mb-3">
                  <strong class="text-muted">Paid At:</strong>
                  <span class="ms-2">{{ order.paid_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% endif %}
                {% if order.shipped_at %}
                <div class="mb-3">
                  <strong class="text-muted">Shipped At:</strong>
                  <span class="ms-2">{{ order.shipped_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% endif %}
                {% if order.delivered_at %}
                <div class="mb-3">
                  <strong class="text-muted">Delivered At:</strong>
                  <span class="ms-2">{{ order.delivered_at.strftime('%d %b %Y, %I:%M %p') }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Customer Notes -->
            {% if order.customer_note %}
            <div class="alert alert-info mt-3">
              <strong><i class="bi bi-chat-text me-2"></i>Customer Note:</strong>
              <p class="mb-0 mt-1">{{ order.customer_note }}</p>
            </div>
            {% endif %}

            <!-- Admin Notes -->
            <div class="admin-notes-section mt-3">
              <form id="adminNoteForm">
                <div class="mb-2">
                  <label for="admin_note" class="form-label fw-semibold">
                    <i class="bi bi-pencil me-1"></i>Admin Notes
                  </label>
                  <textarea class="form-control" id="admin_note" name="admin_note" rows="3"
                            placeholder="Add internal notes about this order...">{{ order.admin_note or '' }}</textarea>
                </div>
                <button type="submit" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-save me-1"></i>Save Notes
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="card mb-4" data-aos="fade-up" data-aos-delay="100">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-cart me-2"></i>Order Items ({{ order.items|length }})
            </h5>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>GST</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in order.items %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        {% if item.product_image %}
                        <img src="{{ item.product_image }}" alt="{{ item.product_name }}"
                             class="rounded me-3" width="50" height="50" style="object-fit: cover;">
                        {% else %}
                        <div class="rounded bg-light d-flex align-items-center justify-content-center me-3"
                             style="width: 50px; height: 50px;">
                          <i class="bi bi-image text-muted"></i>
                        </div>
                        {% endif %}
                        <div>
                          <h6 class="mb-1">{{ item.product_name }}</h6>
                          <small class="text-muted">SKU: {{ item.product_sku }}</small>
                          {% if item.variation_attributes %}
                          <div class="mt-1">
                            {% for attr, value in item.variation_attributes.items() %}
                            <small class="badge bg-light text-dark me-1">{{ attr }}: {{ value }}</small>
                            {% endfor %}
                          </div>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td class="fw-bold">₹{{ "%.2f"|format(item.unit_price) }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>
                      <small class="text-muted">{{ item.gst_rate }}%</small>
                      <br>
                      <small>₹{{ "%.2f"|format(item.gst_amount) }}</small>
                    </td>
                    <td class="fw-bold text-success">₹{{ "%.2f"|format(item.total_price) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Order History -->
        <div class="card" data-aos="fade-up" data-aos-delay="200">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-clock-history me-2"></i>Order History
            </h5>
          </div>
          <div class="card-body">
            {% if order_history %}
            <div class="timeline">
              {% for history in order_history %}
              <div class="timeline-item mb-3">
                <div class="d-flex">
                  <div class="timeline-badge">
                    <i class="bi bi-{{
                      'check-circle' if history.field_changed == 'status' and history.new_value == 'delivered'
                      else 'truck' if history.field_changed == 'status' and history.new_value == 'shipped'
                      else 'credit-card' if history.field_changed == 'payment_status'
                      else 'info-circle'
                    }} text-primary"></i>
                  </div>
                  <div class="timeline-content ms-3 flex-grow-1">
                    <div class="d-flex justify-content-between">
                      <strong>{{ history.field_changed|replace('_', ' ')|title }}</strong>
                      <small class="text-muted">{{ history.created_at.strftime('%d %b %Y, %I:%M %p') }}</small>
                    </div>
                    <div class="text-muted">
                      {% if history.old_value and history.new_value %}
                      Changed from <span class="fw-semibold">{{ history.old_value }}</span>
                      to <span class="fw-semibold text-primary">{{ history.new_value }}</span>
                      {% else %}
                      {{ history.reason or 'System update' }}
                      {% endif %}
                    </div>
                    {% if history.changed_by %}
                    <small class="text-muted">By: {{ history.changed_by_user.first_name }} {{ history.changed_by_user.last_name }}</small>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-4">
              <i class="bi bi-clock-history display-4 text-muted"></i>
              <p class="text-muted mt-3">No order history recorded yet</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Sidebar - Actions & Information -->
      <div class="col-lg-4">
        <!-- Order Actions -->
        <div class="card mb-4" data-aos="fade-left">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-lightning me-2"></i>Order Actions
            </h5>
          </div>
          <div class="card-body">
            <!-- Status Update -->
            <div class="mb-4">
              <label class="form-label fw-semibold">Update Order Status</label>
              <form id="statusUpdateForm">
                <div class="input-group">
                  <select class="form-select" id="orderStatus" name="status">
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  </select>
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i>
                  </button>
                </div>
              </form>
            </div>

            <!-- Quick Actions -->
            <div class="d-grid gap-2">
              {% if order.status != 'cancelled' and order.status != 'delivered' %}
              <button class="btn btn-warning" id="sendTrackingEmail">
                <i class="bi bi-envelope me-2"></i>Send Tracking Email
              </button>
              {% endif %}

              {% if order.payment_status == 'pending' %}
              <button class="btn btn-success" id="markAsPaid">
                <i class="bi bi-credit-card me-2"></i>Mark as Paid
              </button>
              {% endif %}

              {% if order.status != 'cancelled' %}
              <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">
                <i class="bi bi-x-circle me-2"></i>Cancel Order
              </button>
              {% endif %}

              <a href="{{ url_for('admin.orders') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Orders
              </a>
            </div>
          </div>
        </div>

        <!-- Customer Information -->
        <div class="card mb-4" data-aos="fade-left" data-aos-delay="100">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-person me-2"></i>Customer Information
            </h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <strong class="text-muted d-block">Customer</strong>
              {% if order.user %}
              <span>{{ order.user.first_name }} {{ order.user.last_name }}</span>
              <br>
              <small class="text-muted">{{ order.user.email }}</small>
              {% if order.user.phone %}
              <br>
              <small class="text-muted">{{ order.user.country_code }} {{ order.user.phone }}</small>
              {% endif %}
              {% else %}
              <span class="text-muted">Guest Customer</span>
              {% endif %}
            </div>

            <!-- Shipping Address -->
            <div class="mb-3">
              <strong class="text-muted d-block">Shipping Address</strong>
              {% if order.shipping_address %}
              <div class="small">
                {{ order.shipping_address.full_name }}<br>
                {{ order.shipping_address.address_line1 }}<br>
                {% if order.shipping_address.address_line2 %}
                {{ order.shipping_address.address_line2 }}<br>
                {% endif %}
                {% if order.shipping_address.landmark %}
                {{ order.shipping_address.landmark }}<br>
                {% endif %}
                {{ order.shipping_address.city }}, {{ order.shipping_address.state }}<br>
                {{ order.shipping_address.postal_code }}, {{ order.shipping_address.country }}<br>
                {{ order.shipping_address.phone }}
              </div>
              {% else %}
              <span class="text-muted">No shipping address provided</span>
              {% endif %}
            </div>

            <!-- Billing Address -->
            <div class="mb-3">
              <strong class="text-muted d-block">Billing Address</strong>
              {% if order.billing_address %}
              <div class="small">
                {{ order.billing_address.full_name }}<br>
                {{ order.billing_address.address_line1 }}<br>
                {% if order.billing_address.address_line2 %}
                {{ order.billing_address.address_line2 }}<br>
                {% endif %}
                {{ order.billing_address.city }}, {{ order.billing_address.state }}<br>
                {{ order.billing_address.postal_code }}, {{ order.billing_address.country }}<br>
                {{ order.billing_address.phone }}
              </div>
              {% else %}
              <span class="text-muted">Same as shipping address</span>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="card" data-aos="fade-left" data-aos-delay="200">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="bi bi-receipt me-2"></i>Order Summary
            </h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Subtotal:</span>
              <strong>₹{{ "%.2f"|format(order.subtotal) }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Shipping:</span>
              <strong>₹{{ "%.2f"|format(order.shipping_amount) }}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Tax (GST):</span>
              <strong>₹{{ "%.2f"|format(order.tax_amount) }}</strong>
            </div>
            {% if order.discount_amount > 0 %}
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted">Discount:</span>
              <strong class="text-success">-₹{{ "%.2f"|format(order.discount_amount) }}</strong>
            </div>
            {% endif %}
            <hr>
            <div class="d-flex justify-content-between mb-2">
              <span class="fw-bold">Total:</span>
              <strong class="text-success fs-5">₹{{ "%.2f"|format(order.total_amount) }}</strong>
            </div>

            <!-- GST Information -->
            {% if order.is_gst_invoice and order.gst_number %}
            <div class="mt-3 p-2 bg-light rounded">
              <small class="text-muted d-block">GST Invoice</small>
              <strong class="small">{{ order.gst_number }}</strong>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelOrderModalLabel">
          <i class="bi bi-x-circle me-2 text-danger"></i>Cancel Order
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="cancelOrderForm">
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Are you sure you want to cancel this order? This action cannot be undone.
          </div>
          <div class="mb-3">
            <label for="cancelReason" class="form-label">Reason for Cancellation</label>
            <textarea class="form-control" id="cancelReason" name="reason" rows="3"
                      placeholder="Please provide a reason for cancellation..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-x-circle me-2"></i>Cancel Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Admin Order Detail JavaScript -->
<script src="{{ url_for('static', filename='js/admin_order_detail.js') }}"></script>
{% endblock %}
