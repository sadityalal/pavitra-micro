{% extends "admin/base.html" %}

{% block title %}Product Management - Pavitra Enterprises{% endblock %}

{% block page_title %}Product Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Products</li>
{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="section">
  <div class="container-fluid">
    <div class="row align-items-center mb-4">
      <div class="col-md-8">
        <h2 class="mb-1" data-aos="fade-right">Product Catalog</h2>
        <p class="text-muted mb-0" data-aos="fade-right" data-aos-delay="100">
          Manage your product inventory and listings
        </p>
      </div>
      <div class="col-md-4 text-end">
        <a href="{{ url_for('admin.new_product') }}" class="btn btn-primary" data-aos="fade-left">
          <i class="bi bi-plus-circle me-2"></i>Add New Product
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Filters Section -->
<section class="section">
  <div class="container-fluid">
    <div class="card" data-aos="fade-up">
      <div class="card-body">
        <form method="GET" class="row g-3">
          <div class="col-xl-3 col-md-6">
            <label class="form-label fw-semibold">Category</label>
            <select name="category_id" class="form-select">
              <option value="">All Categories</option>
              {% for category in categories %}
              <option value="{{ category.id }}" {% if category_id == category.id %}selected{% endif %}>
                {{ category.name }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-xl-3 col-md-6">
            <label class="form-label fw-semibold">Stock Status</label>
            <select name="stock_filter" class="form-select">
              <option value="">All Stock</option>
              <option value="low" {% if stock_filter == 'low' %}selected{% endif %}>Low Stock</option>
              <option value="out" {% if stock_filter == 'out' %}selected{% endif %}>Out of Stock</option>
              <option value="in_stock" {% if stock_filter == 'in_stock' %}selected{% endif %}>In Stock</option>
            </select>
          </div>

          <div class="col-xl-3 col-md-6">
            <label class="form-label fw-semibold">Status</label>
            <select name="status_filter" class="form-select">
              <option value="all">All Status</option>
              <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
              <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
              <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
            </select>
          </div>

          <div class="col-xl-3 col-md-6">
            <label class="form-label fw-semibold">Search Products</label>
            <div class="input-group">
              <input type="text" name="q" class="form-control" placeholder="Search by name or SKU..." value="{{ search_query }}">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<!-- Products Table Section -->
<section class="section">
  <div class="container-fluid">
    <div class="card" data-aos="fade-up" data-aos-delay="100">
      <div class="card-body">
        {% if products %}
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Product</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for product in products %}
              <tr data-aos="fade-up" data-aos-delay="{{ 150 + loop.index0 * 50 }}">
                <td>
                  <div class="d-flex align-items-center">
                    <img src="{{ product.main_image_url or url_for('static', filename='img/product/placeholder.jpg') }}"
                         alt="{{ product.name }}" class="rounded me-3" width="60" height="60" style="object-fit: cover;">
                    <div>
                      <h6 class="mb-1 fw-semibold">{{ product.name }}</h6>
                      <small class="text-muted">{{ product.brand.name if product.brand else 'No Brand' }}</small>
                    </div>
                  </div>
                </td>

                <td>
                  <code class="bg-light px-2 py-1 rounded">{{ product.sku }}</code>
                </td>

                <td>
                  <span class="badge bg-light text-dark">
                    {{ product.category.name if product.category else 'Uncategorized' }}
                  </span>
                </td>

                <td>
                  <div class="d-flex flex-column">
                    <strong class="text-primary">₹{{ "%.2f"|format(product.base_price) }}</strong>
                    {% if product.compare_price and product.compare_price > product.base_price %}
                    <small class="text-muted text-decoration-line-through">₹{{ "%.2f"|format(product.compare_price) }}</small>
                    {% endif %}
                  </div>
                </td>

                <td>
                  {% if product.track_inventory %}
                  <div class="d-flex align-items-center">
                    <span class="badge
                      {% if product.stock_quantity == 0 %}bg-danger
                      {% elif product.stock_quantity <= product.low_stock_threshold %}bg-warning
                      {% else %}bg-success{% endif %} me-2">
                      {{ product.stock_quantity }}
                    </span>
                    {% if product.stock_quantity <= product.low_stock_threshold and product.stock_quantity > 0 %}
                    <i class="bi bi-exclamation-triangle text-warning" title="Low Stock"></i>
                    {% endif %}
                  </div>
                  {% else %}
                  <span class="badge bg-secondary">No Tracking</span>
                  {% endif %}
                </td>

                <td>
                  <div class="d-flex flex-column gap-1">
                    <span class="badge
                      {% if product.status == 'active' %}bg-success
                      {% elif product.status == 'draft' %}bg-secondary
                      {% else %}bg-danger{% endif %}">
                      {{ product.status|title }}
                    </span>
                    {% if product.is_featured %}
                    <span class="badge bg-primary">Featured</span>
                    {% endif %}
                    {% if product.is_on_sale %}
                    <span class="badge bg-warning">On Sale</span>
                    {% endif %}
                  </div>
                </td>

                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('admin.edit_product', product_id=product.id) }}"
                       class="btn btn-outline-primary" title="Edit Product">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" class="btn btn-outline-warning"
                            onclick="updateStock({{ product.id }}, {{ product.stock_quantity }})"
                            title="Update Stock">
                      <i class="bi bi-clipboard-data"></i>
                    </button>
                    <form method="POST" action="{{ url_for('admin.delete_product', product_id=product.id) }}"
                          class="d-inline" onsubmit="return confirmDelete()">
                      <button type="submit" class="btn btn-outline-danger" title="Delete Product">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <nav aria-label="Product pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('admin.products', page=pagination.prev_num, category_id=category_id, stock_filter=stock_filter, status_filter=status_filter, q=search_query) }}">
                <i class="bi bi-chevron-left"></i> Previous
              </a>
            </li>
            {% endif %}

            {% for page_num in pagination.iter_pages() %}
              {% if page_num %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('admin.products', page=page_num, category_id=category_id, stock_filter=stock_filter, status_filter=status_filter, q=search_query) }}">{{ page_num }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('admin.products', page=pagination.next_num, category_id=category_id, stock_filter=stock_filter, status_filter=status_filter, q=search_query) }}">
                Next <i class="bi bi-chevron-right"></i>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-5" data-aos="zoom-in">
          <i class="bi bi-box display-1 text-muted"></i>
          <h4 class="text-muted mt-3">No products found</h4>
          <p class="text-muted mb-4">Try adjusting your filters or add a new product to get started.</p>
          <a href="{{ url_for('admin.new_product') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Add Your First Product
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Quick Stats Section -->
<section class="section">
  <div class="container-fluid">
    <div class="row gy-4">
      <div class="col-md-3">
        <div class="stats-card card text-center" data-aos="fade-up" data-aos-delay="200">
          <div class="card-body">
            <i class="bi bi-box-seam display-6 text-primary mb-3"></i>
            <h3>{{ products|length }}</h3>
            <p class="text-muted mb-0">Products Displayed</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stats-card card text-center" data-aos="fade-up" data-aos-delay="250">
          <div class="card-body">
            <i class="bi bi-check-circle display-6 text-success mb-3"></i>
            <h3>{{ products|selectattr('status', 'equalto', 'active')|list|length }}</h3>
            <p class="text-muted mb-0">Active Products</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stats-card card text-center" data-aos="fade-up" data-aos-delay="300">
          <div class="card-body">
            <i class="bi bi-exclamation-triangle display-6 text-warning mb-3"></i>
            <h3>{{ products|selectattr('stock_quantity', 'le', 5)|list|length }}</h3>
            <p class="text-muted mb-0">Low Stock Items</p>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="stats-card card text-center" data-aos="fade-up" data-aos-delay="350">
          <div class="card-body">
            <i class="bi bi-star display-6 text-info mb-3"></i>
            <h3>{{ products|selectattr('is_featured', 'equalto', true)|list|length }}</h3>
            <p class="text-muted mb-0">Featured Products</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Stock Update Modal -->
<div class="modal fade" id="stockModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Update Stock Quantity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="stockForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label for="stockQuantity" class="form-label fw-semibold">New Stock Quantity</label>
            <input type="number" class="form-control" id="stockQuantity" name="stock_quantity" min="0" required>
          </div>
          <div class="mb-3">
            <label for="stockReason" class="form-label fw-semibold">Reason (Optional)</label>
            <input type="text" class="form-control" id="stockReason" name="reason" placeholder="e.g., New shipment, adjustment, etc.">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Stock</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin_product.js') }}"></script>
{% endblock %}
